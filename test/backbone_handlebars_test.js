// Generated by CoffeeScript 1.3.1
(function() {

  window.test = {
    views: {
      SubView: Backbone.View.extend({
        className: 'sub-view'
      }),
      SubViewWithEvents: Backbone.View.extend({
        className: 'sub-view',
        events: {
          click: function() {
            return this.$el.html('clicked');
          }
        }
      }),
      SubViewExpectingTemplate: Backbone.View.extend({
        className: 'sub-view',
        template: Handlebars.compile('text'),
        render: function() {
          return this.$el.html(this.template({}));
        }
      }),
      SubViewWithModel: Backbone.View.extend({
        className: 'sub-view',
        render: function() {
          return this.$el.html(this.model);
        }
      })
    }
  };

  describe("Backbone.Handlebars", function() {
    var renderView, _view;
    _view = null;
    afterEach(function() {
      if (_view) {
        _view.remove();
      }
      return _view = null;
    });
    renderView = function(template, context) {
      var customViewClass;
      if (template == null) {
        template = '';
      }
      if (context == null) {
        context = {};
      }
      customViewClass = Backbone.View.extend({
        template: Handlebars.compile(template),
        initialize: function() {
          return this.renderTemplate(context);
        }
      });
      return _view = new customViewClass;
    };
    describe("View#renderTemplate", function() {
      it("renders the template of the view", function() {
        var view;
        view = renderView('template text');
        return view.$el.html().should.eql('template text');
      });
      it("accepts template context as argument", function() {
        var view;
        view = renderView('{{a}} + {{b}} = {{c}}', {
          a: 1,
          b: 2,
          c: 3
        });
        return view.$el.html().should.eql('1 + 2 = 3');
      });
      return it("returns the view", function() {
        var view;
        view = renderView();
        return view.renderTemplate().should.eql(view);
      });
    });
    return describe("View#renderTemplate with {{view}} helper", function() {
      it("renders sub-view element", function() {
        var view;
        view = renderView('{{view "test.views.SubView"}}');
        return view.$('.sub-view').should.not.be["null"];
      });
      it("keeps the events of the sub-view", function() {
        var subViewEl, view;
        view = renderView('{{view "test.views.SubViewWithEvents"}}');
        subViewEl = view.$('.sub-view');
        subViewEl.click();
        return subViewEl.html().should.eql('clicked');
      });
      it("can render several sub-views", function() {
        var view;
        view = renderView('{{view "test.views.SubView"}}{{view "test.views.SubView"}}');
        return view.$('.sub-view').length.should.eql(2);
      });
      it("throws an error if sub-view doesn't exists", function() {
        return (function() {
          return renderView('{{view "InvalidView"}}');
        }).should["throw"]('Invalid view name - InvalidView');
      });
      it("can pass options to the sub-view", function() {
        var subViewEl, view;
        view = renderView('{{view "test.views.SubViewWithModel" model=1 tagName="span" className="sview"}}');
        subViewEl = view.$('.sview');
        subViewEl.html().should.eql('1');
        return subViewEl.prop('tagName').toLowerCase().should.eql('span');
      });
      it("can pass a new template for the view", function() {
        var view;
        view = renderView('{{#view "test.views.SubViewExpectingTemplate"}}custom template{{/view}} ');
        return view.$('.sub-view').html().should.eql('custom template');
      });
      it("removes sub-views via view.remove() on re-render", function() {
        var removeCounter, subView, view, _i, _len, _ref;
        view = renderView('{{view "test.views.SubView"}}{{view "test.views.SubView"}}');
        removeCounter = 0;
        _ref = view.renderedSubViews();
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          subView = _ref[_i];
          subView.remove = function() {
            return removeCounter += 1;
          };
        }
        view.renderTemplate();
        return removeCounter.should.eql(2);
      });
      return it("removes sub-views via view.remove() on view removal", function() {
        var removeCounter, subView, view, _i, _len, _ref;
        view = renderView('{{view "test.views.SubView"}}{{view "test.views.SubView"}}');
        removeCounter = 0;
        _ref = view.renderedSubViews();
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          subView = _ref[_i];
          subView.remove = function() {
            return removeCounter += 1;
          };
        }
        view.remove();
        return removeCounter.should.eql(2);
      });
    });
  });

}).call(this);
